name: build

on:
    push:
        branches: [master]
        paths-ignore:
            - "README.md"
            - "CHANGELOG.md"
            - ".gitignore"
    pull_request:
        branches: [master]
        paths-ignore:
            - "README.md"
            - "CHANGELOG.md"
            - ".gitignore"

env:
    CARGO_TERM_COLOR: always

jobs:
    check:
        name: Check
        runs-on: ubuntu-latest
        env:
            RUSTFLAGS: -Dwarnings
        steps:
            - uses: actions/checkout@v2
              with:
                  submodules: true

            - name: Install Rust
              uses: dtolnay/rust-toolchain@stable

            - name: Cargo check
              run: cargo check --all-features

    test:
        name: Test
        runs-on: ${{ matrix.config.os }}
        needs: check
        strategy:
            fail-fast: false
            matrix:
                config:
                    - { os: "ubuntu-latest", toolchain: "stable" }
                    - { os: "ubuntu-latest", toolchain: "beta" }
                    - { os: "ubuntu-latest", toolchain: "nightly" }
                    - { os: "windows-latest", toolchain: "stable" }
                    - { os: "macOS-latest", toolchain: "stable" }
        steps:
            - uses: actions/checkout@v2
              with:
                  submodules: true

            - name: Install Rust
              uses: dtolnay/rust-toolchain@master
              with:
                  toolchain: ${{ matrix.config.toolchain }}

            - name: Cargo build
              run: cargo build --all-features
              continue-on-error: ${{ matrix.config.toolchain == 'nightly' }}

            - name: Cargo test
              run: cargo test --all-features
              continue-on-error: ${{ matrix.config.toolchain == 'nightly' }}

    style:
        name: Check Style
        runs-on: ubuntu-latest
        needs: check
        steps:
            - uses: actions/checkout@v2
              with:
                  submodules: true

            - name: Install Rust
              uses: dtolnay/rust-toolchain@stable
              with:
                  components: clippy, rustfmt

            - name: Run cargo fmt
              run: cargo fmt --all -- --check

            - name: Run cargo clippy
              run: cargo clippy --all-features

    tarpaulin:
        name: Report coverage
        runs-on: ubuntu-latest
        needs: check
        if: github.event_name != 'pull_request'
        container:
            image: xd009642/tarpaulin:develop-nightly
            options: --security-opt seccomp=unconfined

        steps:
            - name: Checkout repository
              uses: actions/checkout@v2

            - name: Generate code coverage
              run: |
                  cargo +nightly tarpaulin --verbose --all-features --workspace --timeout 120 --out Xml

            - name: Upload coverage
              uses: codecov/codecov-action@v3
              with:
                  token: ${{ secrets.CODECOV_TOKEN }}
                  fail_ci_if_error: true
